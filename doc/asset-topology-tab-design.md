# 资产拓扑 Tab 页设计文档

## 一、概述

### 1.1 背景

在资产列表页面点击资产名称后，会弹出 `TargetMetaDrawer` 抽屉组件展示资产详情。当前抽屉仅展示资产的元数据信息（platform、cpu、memory、network、filesystem 等），需要新增一个"拓扑"标签页来展示资产的拓扑关系图。

### 1.2 目标

- 清晰直观地展示硬件设备（服务器、交换机、路由器、防火墙、存储设备等）的拓扑关系
- 支持位置关系和部署关系两种拓扑视图
- 通过流程图形式展示节点间的层级关系

## 二、功能需求

### 2.1 拓扑类型

- **全部拓扑**：默认展示，包含位置关系和部署关系的完整拓扑图
- **位置拓扑**：仅展示资产的位置层级关系（机房 → 机柜 → 设备）
- **部署拓扑**：仅展示资产的软件部署关系（设备 → 软件系统）

### 2.2 节点设计

所有节点统一设计，不区分类型：

- **显示内容**：仅显示节点名称
- **节点样式**：
  - 卡片形式展示
  - 所有节点使用统一的卡片样式
  - 不区分服务器、机柜、机房、软件等类型
  - 通过连接关系体现节点间的层级和部署关系

### 2.3 连接关系

- **位置关系**：机房 → 机柜 → 设备（层级关系，用实线连接）
- **部署关系**：设备 → 软件系统（部署关系，用虚线或不同颜色连接）
- **连接线样式**：
  - 位置关系：实线，颜色 #A2B1C3
  - 部署关系：虚线，颜色 #5F95FF

## 三、UI/UX 设计

### 3.1 抽屉结构改造

当前 `TargetMetaDrawer` 组件需要改造为支持标签页的结构：

```
Drawer
├── Tabs
    ├── Tab 1: "元数据" (原有功能)
    │   └── Group组件列表（platform, cpu, memory, network, filesystem）
    └── Tab 2: "拓扑" (新增)
        └── 拓扑视图组件
```

### 3.2 拓扑 Tab 页布局

```
┌─────────────────────────────────────────┐
│  拓扑类型选择器                          │
│  [全部] [位置] [部署]                    │
├─────────────────────────────────────────┤
│                                         │
│           拓扑画布区域                   │
│    (可缩放、可拖拽、可平移)              │
│                                         │
│    [节点卡片] ←→ [节点卡片]             │
│         ↓                                │
│    [节点卡片]                            │
│                                         │
└─────────────────────────────────────────┘
```

### 3.3 拓扑类型选择器

- **位置**：抽屉顶部，标签页下方
- **样式**：Radio.Group 或 Segmented 组件
- **选项**：
  - 全部拓扑（默认）
  - 位置拓扑
  - 部署拓扑

### 3.4 拓扑画布

- **尺寸**：自适应抽屉宽度（800px），高度建议 600px
- **背景**：浅灰色 (#f2f4f7) 或根据主题适配
- **交互功能**：
  - 鼠标滚轮缩放（Ctrl + 滚轮）
  - 拖拽画布平移（鼠标中键或拖拽空白区域）
  - 拖拽节点调整位置
  - 点击节点查看详情（可选）
  - 悬停节点高亮显示

### 3.5 节点卡片设计

所有节点使用统一的卡片样式，仅显示名称：

```
┌─────────────────────┐
│   节点名称            │
└─────────────────────┘
```

- **卡片内容**：仅显示节点名称文本
- **卡片样式**：统一的矩形卡片，所有节点样式一致
- **卡片尺寸**：根据名称长度自适应，最小宽度 80px，最大宽度 200px
- **文字样式**：居中显示，字体大小 12px - 14px

## 四、技术实现方案

### 4.1 技术选型

- **图形库**：使用 `@antv/x6`（项目已有使用经验）
  - 支持节点、边的绘制
  - 支持拖拽、缩放、平移等交互
  - 支持自定义节点样式
  - 性能良好，适合复杂拓扑图

### 4.2 组件结构

```
TargetMetaDrawer/
├── index.tsx (主组件，包含Tabs)
├── MetaDataTab.tsx (元数据标签页，原有功能)
├── TopologyTab.tsx (拓扑标签页，新增)
│   ├── TopologyTypeSelector.tsx (拓扑类型选择器)
│   ├── TopologyCanvas.tsx (拓扑画布)
│   │   ├── NodeCard.tsx (节点卡片组件)
│   │   └── EdgeRenderer.tsx (连接线渲染)
│   └── TopologyToolbar.tsx (工具栏，可选)
└── style.less (样式文件)
```

### 4.3 数据模型

#### 4.3.1 拓扑数据结构

```typescript
interface TopologyData {
  nodes: TopologyNode[];
  edges: TopologyEdge[];
}

interface TopologyNode {
  id: string;
  name: string; // 节点名称，所有节点统一只显示名称
  type?: 'server' | 'rack' | 'idc' | 'software' | 'switch' | 'router' | 'firewall' | 'storage'; // 节点类型（可选，仅用于后端区分，前端不展示）
  position?: { x: number; y: number }; // 节点位置（可选，用于保存布局）
}

interface TopologyEdge {
  id: string;
  source: string; // 源节点ID
  target: string; // 目标节点ID
  type: 'location' | 'deployment'; // 关系类型
}
```

#### 4.3.2 API 接口设计

```typescript
// 获取资产拓扑数据
getAssetTopology(ident: string): Promise<TopologyData>

// 接口路径：/cmdb/asset/{ident}/topology
// 请求方法：GET
// 返回数据格式：
{
  dat: {
    nodes: TopologyNode[],
    edges: TopologyEdge[]
  }
}
```

### 4.4 核心功能实现

#### 4.4.1 拓扑类型切换

- 监听拓扑类型选择器的变化
- 根据选择的类型过滤节点和边
- 重新渲染拓扑图

#### 4.4.2 节点渲染

- 使用 X6 的自定义节点功能
- 所有节点使用统一的卡片样式，仅显示节点名称
- 不区分节点类型，所有节点外观一致
- 支持节点拖拽和位置保存（可选）

#### 4.4.3 连接线渲染

- 位置关系：使用实线连接
- 部署关系：使用虚线连接
- 支持箭头指向（可选）

#### 4.4.4 布局算法

- **位置拓扑**：使用层级布局（Hierarchical Layout）
  - 机房在最上层
  - 机柜在中间层
  - 设备在最下层
- **部署拓扑**：使用力导向布局（Force Layout）或圆形布局
  - 设备节点在中心
  - 软件节点围绕设备分布
- **全部拓扑**：结合两种布局，或使用自定义布局算法

### 4.5 性能优化

- 大量节点时使用虚拟渲染
- 防抖处理缩放和拖拽事件

## 五、交互设计

### 5.1 拓扑类型切换

- 点击切换按钮后，平滑过渡到新的拓扑视图
- 保持当前缩放和位置（如可能）

### 5.2 节点交互

- **悬停**：节点高亮显示（边框颜色加深或背景色变化）
- **点击**：可选功能，跳转到资产详情或显示侧边栏
- **拖拽**：调整节点位置（仅在前端，不保存到后端）

### 5.3 画布交互

- **缩放**：Ctrl + 鼠标滚轮，缩放范围 0.5x - 3x
- **平移**：鼠标中键拖拽或拖拽空白区域
- **重置视图**：提供"适应画布"按钮（可选）

## 六、样式设计

### 6.1 主题适配

- 支持深色模式和浅色模式
- 节点卡片背景色根据主题调整
- 连接线颜色根据主题调整

### 6.2 颜色规范

- **位置关系线**：#A2B1C3（浅蓝灰）
- **部署关系线**：#5F95FF（蓝色）
- **节点卡片背景**：根据主题（浅色：#fff，深色：#1f1f1f）
- **节点卡片边框**：根据主题（浅色：#d9d9d9，深色：#434343）
- **节点文字颜色**：根据主题（浅色：#000，深色：#fff）

### 6.3 字体和间距

- 节点卡片内文字：12px - 14px
- 节点卡片内边距：8px - 12px
- 节点卡片间距：根据布局算法自动计算

## 七、边界情况处理

### 7.1 数据为空

- 显示空状态提示："暂无拓扑数据"
- 提供刷新按钮

### 7.2 数据加载失败

- 显示错误提示
- 提供重试按钮

### 7.3 节点过多

- 使用虚拟渲染
- 提供搜索/过滤功能（可选）
- 提供节点分组/折叠功能（可选）

### 7.4 关系复杂

- 支持边的弯曲显示（避免重叠）
- 支持边的标签显示（可选）

## 八、扩展功能（可选）

### 8.1 节点搜索

- 在拓扑图中搜索节点
- 高亮显示匹配的节点

### 8.2 节点详情

- 点击节点显示详情侧边栏
- 显示节点的完整属性信息

### 8.3 导出功能

- 导出拓扑图为图片（PNG/SVG）
- 导出拓扑数据为 JSON

### 8.4 布局保存

- 保存用户自定义的节点位置
- 下次打开时恢复布局

## 九、开发计划

### 9.1 第一阶段：基础功能

1. 改造 `TargetMetaDrawer` 组件，添加 Tabs
2. 创建 `TopologyTab` 组件框架
3. 集成 X6 图形库
4. 实现基础节点和边的渲染

### 9.2 第二阶段：数据对接

1. 设计并实现 API 接口
2. 实现数据获取和解析
3. 实现拓扑类型切换功能

### 9.3 第三阶段：布局和交互

1. 实现布局算法
2. 实现画布交互（缩放、平移、拖拽）
3. 优化节点卡片样式

### 9.4 第四阶段：优化和测试

1. 性能优化
2. 主题适配
3. 边界情况处理
4. 测试和修复

## 十、注意事项

1. **性能**：拓扑图可能包含大量节点，需要注意性能优化
2. **响应式**：抽屉宽度固定为 800px，但需要考虑不同屏幕尺寸
3. **可访问性**：确保键盘导航和屏幕阅读器支持（如需要）
4. **浏览器兼容性**：确保在主流浏览器中正常工作
5. **数据一致性**：确保拓扑数据与资产列表数据保持一致
